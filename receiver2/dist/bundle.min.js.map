{"version":3,"file":"bundle.min.js","sources":["../src/logger.ts","../src/cast_receiver.ts"],"sourcesContent":["export class Logger {\n  private logger: debug.CastDebugLogger;\n  private name: string;\n\n  constructor(name: string, logger: debug.CastDebugLogger) {\n    this.name = name;\n\n    this.logger = logger;\n\n    this.logger.setEnabled(true);\n    this.logger.loggerLevelByEvents = {\n      \"cast.framework.events.category.CORE\": cast.framework.LoggerLevel.INFO,\n      \"cast.framework.events.EventType.MEDIA_STATUS\": cast.framework.LoggerLevel.DEBUG,\n    };\n    if (!this.logger.loggerLevelByTags) {\n      this.logger.loggerLevelByTags = {};\n    }\n    this.logger.loggerLevelByTags[this.name] = cast.framework.LoggerLevel.DEBUG;\n    // Set to true to show debug overlay.\n    // this.logger.showDebugLogs(true);\n  }\n\n  public debug(...args: any[]) {\n    // console.log(`[${this.name}]`, ...args);\n    this.logger.info(this.name, ...args);\n  }\n\n  public error(...args: any[]) {\n    this.logger.error(this.name, ...args);\n  }\n\n  public info(...args: any[]) {\n    this.logger.info(this.name, ...args);\n  }\n\n  public warn(...args: any[]) {\n    this.logger.warn(this.name, ...args);\n  }\n}\n","import { CastReceiverContext, PlaybackConfig, PlayerManager } from \"chromecast-caf-receiver/cast.framework\";\nimport {\n  ErrorData,\n  ErrorReason,\n  ErrorType,\n  LoadRequestData,\n  MessageType,\n  RequestData,\n  SeekRequestData,\n} from \"chromecast-caf-receiver/cast.framework.messages\";\nimport { EventType, MediaElementEvent, ErrorEvent } from \"chromecast-caf-receiver/cast.framework.events\";\nimport { CastDebugLogger } from \"chromecast-caf-receiver/cast.debug\";\nimport { Logger } from \"./logger\";\n\nimport SmartWebPlayer from \"../external/smart-web-player\";\nimport { Drm } from \"./drm\";\n\nexport class CastReceiver {\n  private readonly _context: CastReceiverContext;\n  private readonly _playerManager: PlayerManager;\n\n  private readonly logger: Logger;\n  private readonly _player: SmartWebPlayer.BasePlayer;\n\n  constructor() {\n    this._context = CastReceiverContext.getInstance();\n    this._playerManager = this._context.getPlayerManager();\n    this._player = SmartWebPlayer.getSmartPlayer();\n    this._player.init();\n\n    this.logger = new Logger(\"UCast Receiver\", CastDebugLogger.getInstance());\n\n    // Provide an interceptor for LOAD messages.\n    this._playerManager.setMessageInterceptor(MessageType.LOAD, this.handleLoad);\n    this._playerManager.setMessageInterceptor(MessageType.PAUSE, this.handlePause);\n    this._playerManager.setMessageInterceptor(MessageType.PLAY, this.handlePlay);\n    this._playerManager.setMessageInterceptor(MessageType.SEEK, this.handleSeek);\n\n    // Add basic event listeners\n    this._playerManager.addEventListener(EventType.PLAY, this.handlePlayEvent);\n    this._playerManager.addEventListener(EventType.PAUSE, this.handlePauseEvent);\n    this._playerManager.addEventListener(EventType.ERROR, this.handleErrorEvent);\n  }\n\n  // Start receiving requests from senders.\n  public start() {\n    let castReceiverOptions = new cast.framework.CastReceiverOptions();\n    // Do not load unnecessary JS files for players we don't need.\n    castReceiverOptions.skipPlayersLoad = true;\n\n    // Disable the idle timeout. Note that this is something actually useful to have, but it should\n    // be easy to implement with some bookkeeping and `setTimeout`.\n    castReceiverOptions.disableIdleTimeout = true;\n\n    // Enable basic media commands.\n    castReceiverOptions.supportedCommands = cast.framework.messages.Command.ALL_BASIC_MEDIA;\n\n    // Optional, maximize the debug level to diagnose problems.\n    this._context.setLoggerLevel(cast.framework.LoggerLevel.DEBUG);\n\n    this._context.start(castReceiverOptions);\n  }\n\n  // Setup playbackConfig with a sourceDescription license information passed by loadRequestData.\n  private readonly handleLoad = (loadRequestData: LoadRequestData): null => {\n    this.logger.debug(\"LOAD event received\", loadRequestData);\n    // If the loadRequestData is incomplete, return an error message\n    if (!loadRequestData || !loadRequestData.media) {\n      const error = new ErrorData(ErrorType.LOAD_FAILED);\n      error.reason = ErrorReason.INVALID_REQUEST;\n      this.logger.error(\"LOAD_FAILED: Verify the load request is set up properly and the media is able to play.\");\n      return null;\n    }\n\n    const contentId = loadRequestData.media.contentId;\n    const contentUrl = loadRequestData.media.contentUrl;\n    this.logger.debug(\"received contentId\", contentId, \"contentUrl\", contentUrl);\n\n    // Check for sourceDescription\n    const drm = loadRequestData?.media.customData?.drm as Drm | undefined;\n    this.logger.debug(\"received drm\", loadRequestData?.customData, drm);\n    if (drm) {\n      const license = drm.licenseUrl;\n      const jwt = drm.jwt;\n      this._player.setSrc(contentId, {\n        type: \"widevine\",\n        data: { licenseUrl: license },\n        headers: {\n          Authorization: jwt,\n        },\n      });\n    } else {\n      this._player.setSrc(contentId);\n    }\n\n    return null;\n    // const selectedSource = sourceDescription?.sources?.find((source: any) => {\n    //   return source.src === loadRequestData.media.contentId || source.src === loadRequestData.media.contentUrl;\n    // });\n    // if (selectedSource) {\n    //   const playbackConfig = Object.assign(new PlaybackConfig(), this._playerManager.getPlaybackConfig());\n\n    //   // Check for contentProtection (DRM)\n    //   const contentProtection = selectedSource.contentProtection ?? selectedSource.drm;\n    //   if (contentProtection) {\n    //     // Enrich playbackConfig with contentProtection properties.\n    //     // createContentProtectionConfigEnricher(contentProtection)?.enrich(playbackConfig); TODO\n    //   }\n\n    //   // Set an optional manifest request handler\n    //   playbackConfig.manifestRequestHandler = (_request: framework.NetworkRequestInfo) => {\n    //     // request.url = `<proxy>${request.url}`;\n    //   };\n\n    //   // Set an optional segment request handler\n    //   playbackConfig.segmentRequestHandler = (_request: framework.NetworkRequestInfo) => {\n    //     // request.url = `<proxy>${request.url}`;\n    //   };\n\n    //   this._playerManager.setPlaybackConfig(playbackConfig);\n    // }\n\n    // return loadRequestData;\n  };\n\n  private readonly handlePlay = (event: RequestData): null => {\n    this.logger.debug(\"PLAY received\");\n    this._player.play();\n    return null;\n  };\n\n  private readonly handlePause = (event: RequestData): null => {\n    this.logger.debug(\"PAUSE received\");\n    this._player.pause();\n    return null;\n  };\n\n  private readonly handleSeek = (event: SeekRequestData): null => {\n    this.logger.debug(\"SEEK  received\", event.currentTime);\n    this._player.seekTo(event.currentTime ?? 0);\n    return null;\n  };\n\n  private readonly handlePlayEvent = (event: MediaElementEvent): void => {\n    this.logger.debug(\"PLAY event received\", event.currentMediaTime);\n    this._player.play();\n  };\n\n  private readonly handlePauseEvent = (event: MediaElementEvent): void => {\n    this.logger.debug(\"PAUSE event received\", event.currentMediaTime);\n  };\n\n  private readonly handleErrorEvent = (event: ErrorEvent): void => {\n    this.logger.error(\"Detailed Error Code - \" + event.detailedErrorCode);\n  };\n}\n"],"names":["Logger","constructor","name","logger","this","setEnabled","loggerLevelByEvents","cast","framework","LoggerLevel","INFO","DEBUG","loggerLevelByTags","debug","args","info","error","warn","handleLoad","loadRequestData","media","ErrorData","ErrorType","LOAD_FAILED","reason","ErrorReason","INVALID_REQUEST","contentId","contentUrl","drm","_a","customData","license","licenseUrl","jwt","_player","setSrc","type","data","headers","Authorization","handlePlay","event","play","handlePause","pause","handleSeek","currentTime","seekTo","handlePlayEvent","currentMediaTime","handlePauseEvent","handleErrorEvent","detailedErrorCode","_context","CastReceiverContext","getInstance","_playerManager","getPlayerManager","SmartWebPlayer","getSmartPlayer","init","CastDebugLogger","setMessageInterceptor","MessageType","LOAD","PAUSE","PLAY","SEEK","addEventListener","EventType","ERROR","start","castReceiverOptions","CastReceiverOptions","skipPlayersLoad","disableIdleTimeout","supportedCommands","messages","Command","ALL_BASIC_MEDIA","setLoggerLevel"],"mappings":"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"}